---
title: Section Two
header-includes:
   - \usepackage{cleveref}
   - \input{../symbols.tex}
---

# Background

Before describing the process of obtaining arrival time distributions, we must first define the framework with which we obtain vehicle and network state estimates. @cite:Elliott_2020; present a process for constructing a transit road network from raw GTFS data.


## Transit data, GTFS, and a road network

The general structure of transit data has remained fairly standard, tracing back to an initial prescription by @citet:Cathey_2003;. This work introduced terms such as *trip* and *route*, which are continually used today. However, the stucture of the data was massively formalised in 2006 when Google released their first version of *General Transit Feed Specification (GTFS)* @citep:GoogleDevelopers_2006;.

Transit data requires information about *routes*, journeys from an origin to a destination servicing a sequence of *stops* where passengers may board or disembark, and *trips* which are time-specific instances of a route. The path or *shape* travelled by the vehicle is described by a sequence of GPS coordinates. This information is contained within *GTFS static* along with other information one might find on a printed timetable, such as scheduled arrival and departures.

Real-time transit data, on the other hand, includes information about the position of a vehicle. This might be in the form of a *distance travelled* along the route @citep:Wall_1999,Dailey_2001; or, more commonly in modern systems, as GPS coordinates (latitude and longitude) @citep:Cathey_2003,Hans_2015;. The structure and format of this information is described by *GTFS-realtime*.

An important aspect missing from the setup, however, is information about *physical interactions* between separate routes (which may share common roads) which is critical to accurate prediction @citep:Jeong_2005,;. @citet:Elliott_2020; describe a simple process for combining route information from static GTFS data to obtain a *transit road network*, expressing each route as a sequence of physical roads. The benefit of this is that vehicles servicing different routes but using the same road(s) can share information about their speed. This greatly enhances the amount of data available for forecasting arrival times.

```{r road_nw,echo=FALSE}
# figure for the network
```

In the approach, stops are considered *nodes* in the network, while the roads between them are *edges*. Any buses travelling between the same two (or more) stops share the road between them, thus providing information about the speeds. This increases the rate of update and is particularly beneficial for predicting arrival times for low-frequency routes (see \cref{predicting-arrival-time}).

## Recursive Bayes and particle filtering

In a real-time application, performing a full update of the posterior distribution of some parameters becomes hugely inefficient. It is possible to recursively update the posterior, however, by way of recursive Bayesian filtering (alternatively called sequential Monte Carlo). Given a random variable $\vec x = \vec x_{0:k} = \tvec{\vec x_0,\vec x_1,\ldots\,\vec x_k}$ at time $t_k$ following a Markov process with associated observation $\vec y = \vec y_{1:k} = \tvec{\vec y_1,\ldots,\vec y_k}$, the posterior distribution at time $t_k$ is expressed via the recursive formula
\[
p(\vec x_{0:k}\cond{} \vec y_{1:k}) \propto
   p(\vec x_{0:k-1}\cond{} \vec y_{1:k-1})
   p(\vec x_k\cond{}\vec x_{k-1})
   p(\vec y_k\cond{}\vec x_k)
\]
which involves the previous state, next state prediction, and the likelihood, respectively. We therefore need to compute $p(\vec x_k\cond{}\vec x_{k-1})$, which involves the *transition function* between consecutive states, and the likelihood $p(\vec y_k\cond{}\vec x_k)$. The specific details of each of these depends on the model, which is discussed in \cref{estimating-road-state-from-vehicle-observations}.


Estimation of recursive Bayesian models takes many forms, most notably the Kalman filter @citep:; which has been widely used in transit modelling @citep:Wall_1999,Dailey_2001,Cathey_2003,Jeong_2005;. However, as discussed by @citet:Hans_2015,Elliott_2020;, it makes several assumptions which do not work so well with transit vehicles, namely that the errors are normal with a single mode. The particle filter @citep:Gordon_1993; provides a numerical approach to solving recursive Bayesian models, much the same as Markov chain Monte Carlo provides estimates of standard posterior distributions. In a particle filter, the state $\vec x_k$ is represented by a sample of $N$\ particles $\{\vec x_k\vi\}_{i=1}^N$ with associated weights $\{w_k\vi\}_{i=1}^N$. We use the delta measure $\delta$ to express the approximated state
\[
   p(\vec x_{k-1} | \vec y_{0:k-1}) \approx \sum_{i=1}^N w_{k-1}^{(i)} \DiracMeasure{\vec x_{k-1}^{(i)}}{\vec x_{k-1}}.
\]

Particle filter estimates are updated in two steps. First the state prediction of $p(\vec x_k\cond{}\vec x_{k-1})$ is made using the transition function $f$, which implements the vehicle model (\cref{vehicle-model}):
\[
   p(\vec x_{k} | \vec x_{k-1}) \approx
      \sum_{i=1}^N w_{k-1}^{(i)}
         \DiracMeasure{\vec x_{k}^{(i)}}{\vec x_{k}},\quad
   \vec x_k\vi = f(\vec x_{k-1}\vi, \Delta_k, \sigma).
\]

Second is the likelihood update, which quantifies the probability of the observed vehicle position given each of the particle predictions. The particle weights are updated according to their likelihood,
\[
w_k\vi =
   \frac{w_{k-1}\vi p(\vec y_k\cond{}\vec x_k\vi)}{
      \sum_{j=1}^N w_{k-1}\vi[j] p(\vec y_k\cond{}\vec x_k\vi[j])
   }.
\]
For the likelihood function itself, we use an exponential distribution on the geographic distance between the particle and the observed location, as proposed by @citet:Elliott_2020;.

To ensure the *effective sample size* remains adequately large (greater than $\frac{1}{4}N)$, importance resampling of the particles, with replacemnet, is performed whenever the effective sample size $N_{\text{eff}} = \frac{1}{\sum_{i=1}^N (w_k\vi)^2}$ drops below the threshold. The particle filter was for this reason originally called the *bootstrap filter* @citep:Gordon_1993;.


## Estimating road state from vehicle observations

In a transit setup, we observe vehicle locations $\vec y_k$ consisting of the vehicle's latitude and longitude at time $t_k$. The goal is to estimate the vehicle's distance travelled $x$ and speed $\dot x$, from which we can calculate its average speed along individual road segments. The underlying, unobservable state of the vehicle is $\vec x_k = \tvec{x_k,\dots x_k}$.

Estimation of network state involves three steps: vehicle state estimation, estimation of average speed along roads, and updating the network state model.


### Vehicle model

Estimating vehicle state requires a vehicle model consisting of several key behaviours. @cite:Elliott_2020; give details, however of particular importance to arrival time prediction is the *dwell time* model for stop behaviour. When the bus arrives at a stop, it can either drive past, or stop and allow passengers to board and disembark. The model presented here is based directly off that described by @cite:Elliott_2020;, which is itself based of the model described by @cite:Hans_2015;.

When a bus approaches a bus stop, it stops with probability $\pi$ to pick up and drop off passengers. If there are no passengers, the vehicle does not stop and loses no time. However, if it does stop, the time lost doing so is referred to as *dwell time*. Dwell time is composed of two parts:

1. deceleration, doors open and close, acceleration; and
2. servicing passengers

The first is assumed constant for all stops, and is parameterised as $\gamma$, the *minimum dwell time*. The stop service time is given a distribution for each stop. The mean and variance of dwell time at stop $j$, estimated from historical data, are $\tau_j$ and $\omega_j$, respectively. The distribution is assumed to follow a (truncated) normal distribution,
\[
d_j \sim \TNormal{\tau_j}{\omega_j^2}{0}{\infty}.
\]
The total dwell time for a particle is
\[
z_j\vi = p\vi\left(\gamma + d_j\vi \right),\quad
p\vi \sim \Bern{\pi}.
\]
The dwell time model will be used in the arrival time prediction framework described in [[section 3]].


<!--

<!--
## Estimating network state

Having obtained a estimate of the speed of each vehicle along a road, we can proceed to updating the state of the road network itself. This uses a Kalman filter to update the state, $\vec \beta_c$, using the estimated vehicle speeds.

This all provides a flexible method for modelling real-time traffic conditions in any network using only GTFS, and not rely on other data sources (for example taxis or video cameras).

We use a hierarchical model on vehicle travel times, as individual vehicles have different average speeds, even if they travel at the same time, due to different driver behavior and other factors. The between-vehicle noise parameter $\NWvar_\ell$ describes this, and is estimated from historical data.

The observations are also uncertain, as they are estimated from the particle filter. We can assume between-vehicle and measurement uncertainties are independent, so the total variance of observations is
\[ \Var{b_\ell | \vec y_{1:k}} = \NWerr_\ell^2 + \NWvar_\ell^2. \]
The system noise $\NWnoise$ is also estimated from historical data. Together we can quickly update the network state using the information variance of the Kalman filter (since this allows data from multiple sources simultaneously, which can happen when two or more buses are travelling one behind the other).

The result is an estimate of the state of the network at time $t_c$,
\[
   p(\NWstate_c | \cup_m \cup_\ell\ \NWobs_{\ell,c,m}) \sim
   \Normal{\vec\NWstate_\ell}{\NWstatevar^2}.
\]
This can be used to predict the travel time of buses.

If a forecast function is available, we could also forecast future travel time based on current state and historical trends, and this would be incorporated. -->
