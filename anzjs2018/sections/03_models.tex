\section{The Models}
\label{sec:models}

The real-time nature of this application (means that for) both
the vehicle and network models a recursive Bayesian filtering approach is logical,
and indeed real-time tracking and robotics applications often use such (models).
In each of the following models, 
we assume an underlying Markov process with state $\mathcal{X}_k$,
of which observations $\mathcal{Y}_k$ are made,
which leads us to the following general model,
\begin{equation}
\label{eq:rbe_model}
\begin{split}
\mathcal{X}_k &= f(\mathcal{X}_{k-1}, \omega_k) \\
\mathcal{Y}_k &= h(\mathcal{X}_k, \nu_k)
\end{split}
\end{equation}
where $\omega_k\sim\mathrm{N}(0,\mathcal{Q})$ is the system noise,
and $\nu_k\sim\mathrm{N}(0,\mathcal{R})$ is measurement error.
The transition function $f$ determines the relationship between consecutive states,
while the measurement function $h$ is a deterministic function describing the
relationship between the underlying and observed states.

The following sections describe two Bayesian filter models based on (\ref{eq:rbe_model}) used in this application.
The first model is implemented using a particle filter to estimate vehicle states,
with the primary objective of estimating vehicle travel times along roads,
while the second using these estimated times to update road states,
and is implemented using a Kalman filter.

\subsection{Real-time vehicle model}
\label{sec:pf}

The underlying vehicle state at time $t_k$ consists of
the vehicle's distance traveled $x$ in meters along the route and
its speed $\dot x$ in meters per second.
Additionally, we include travel times along road segments along the route, 
$\bz = (z_1,\ldots,z_L)^\top$, in seconds,
which are independent of time but included in the state as they are estimated
sequentially as the vehicle traverses the route.
These are combined into the state vector,
\begin{equation}
\label{eq:vehicle_state}
\bX_k = 
\begin{bmatrix}
    x_k \\ \dot x_k \\ \bz
\end{bmatrix}.
\end{equation}
Observations of the vehicle are made at time $t_k$ using a GPS,
giving the longitude $\lambda_k$ and latitude $\phi_k$ of the vehicle,
giving us the observation vector
\begin{equation}
\label{eq:vehicle_obs}
\bY_k = \begin{bmatrix} \lambda_k \\ \phi_k \end{bmatrix}.
\end{equation}


We decided to employ a particle filter to estimate $\bX_k$,
since it is a highly flexible approach and has been used in recent 
transit vehicle modeling applications \citep{Hans_2015}.
Our main justification for using it is that it handles multimodality very well,
which is a common feature of the proposal distribution particularly around bus stops.
Another advantage is the intuitive likelihood function, 
which is described later.
Conversely, the particle filter is a computationally demanding method,
as thousands of particles are required per bus.
Section~\ref{sec:rt} describes how we were able to implement the particle filter in real-time.


In the particle filter, the posterior distribution of the state at time $t_k$,
is estimated by a set of discrete points, or particles,
\begin{equation}
p(\bX_k | \bY_k) \approx \tilde\bX_{k|k} := (\bX_k^{(i)})_{i=1}^N
\end{equation}
each of which is independently updated or \emph{mutated} using the transition function $f$,
\begin{equation}
p(\bX_k | \bX_{k-1}) \approx \tilde\bX_{k|k-1} := 
\left(f(\bX_{k-1}^{(i)}, \psi)\right)_{i=1}^N
\end{equation}
using a parameter vector $\psi$ containing all of the necessary parameters
for the model (including system noise).
After mutation, \emph{selection} of a new set of particles is performed by
importance resampling using likelihood weights.


\subsubsection{Vehicle transition function}
\label{sec:pf_prediction}
As we are using a particle filter to implement the vehicle model,
the transition function $f$ can be a complex description of bus behaviour,
most notably
\begin{itemize}
\item non-constant speed along roads (acceleration as system noise),
\item stopping and waiting at bus stops while passengers board and disembark, and
\item stopping and waiting at intersections.
\end{itemize}

For each particle, the transition function generates a plausible trajectory,
using system noise parameter $\sigma^2$ which describes 
how the vehicles acceleration changes as a random process.
% In its simplest form, the transition function becomes,
% from Newton's laws of motions,
% \begin{equation}
% \begin{split}
%     x_k &= x_{k-1} + \delta_k \dot x_{k-1} \\
%     \dot x_k &= \dot x_{k-1} + w_k,
%     \quad w_k \sim \mathrm{N}(0, \delta_k \sigma^2)
% \end{split}
% \end{equation}
However, the vehicle does not simply travel constantly along the route,
as it needs to service bus stops along the way.
Therefore, the transition function includes 
stopping probabilities $\boldsymbol\pi = (\pi_1,\ldots,\pi_J)^\top$ at bus stops,
dwell times $\boldsymbol\tau = (\tau_1,\ldots,\tau_J)^\top$ for passengers to
board and disembark (conditional on the bus stopping),
and the minimum dwell time at stops, $\gamma$.
For these parameters, we used constant values for all stops,
and based the values on those used by \cite{Hans_2015};
future work will look at modeling these separately in real-time also.
Also in this application, due to the complexity of the problem,
we use bus stops to define road segments.
Therefore no intersection model is required,
only the segment travel times as predicted by the network model at time $t_k$,
$\btheta(t_k) = (\theta_1(t_k), \ldots, \theta_L(t_k))^\top$
(see section~\ref{sec:kf}).
Future work will adapt this to use intersection that are indpendent 
of bus stops, and therefore completely independent of routes,
which will allow increasing the complexity of the model to incorporate
intersection stopping probabilities and waiting times.
The details of the transition function are given in the algorithm defined in the Appendix,
which implements those features discussed above.



\subsubsection{Updating state using the observation likelihood}
\label{sec:pf_update}

After mutating the particle set, the posterior distribution is obtained by
\emph{selection}, which is implemented by importance resampling using
likelihood weights.
To do so, we need to define the measurement function $h$,
and an additional function $g$ which transforms GPS coordinates onto a flat
surface (the geographical equirectangular projection,
which allows us to place a bivate normal likelihood on the data.
The model for the observation generation is,
assuming GPS error $\epsilon^2$,
\begin{equation}
\label{eq:pf_obs_model}
g(\bY_k) = g(h(\bX_k)) + \br_k,
\quad \br_k \sim \mathrm{N}(\boldsymbol{0}, \epsilon^2\boldsymbol{I})
\end{equation}
However, due to the assumption that error in longitude and latitude are uncorrelated, 
the geographical distance between the observation and the true vehicle can be expressed
in terms of two independent standard normal random variables $z_1$ and $z_2$
\begin{equation}
\label{eq:obs_dist}
dist(\bY_k, h(\bX_k)) = \sqrt{r_{k1}^2 + r_{k2}^2} 
    = \sqrt{(\epsilon z_1)^2 + (\epsilon z_2)^2}
\end{equation}
As the sum of two independent, standard normal random variables 
is $\chi^2$ distributed with 2~degrees of freedom,
which is itself exponential,
rearranging (\ref{eq:obs_dist}) yields
\begin{equation}
\label{eq:obs_exp}
\left(\frac{dist(\bY_k, h(\bX_k))}{\epsilon}\right)^2 =
z_1^2 + z_2^2 \sim \mathrm{Exp}\left(\frac{1}{2}\right)
\end{equation}

The likelihood of the data given a particle's state estimate 
is therefore easy to calculate using (\ref{eq:obs_exp})
\begin{equation}
p(\bY_k | \bX_k^{(i)}, \epsilon) =
\frac{1}{2}\exp\left\{
-\frac{1}{2} \left(\frac{dist(\bY_k, h(\bX_k^{(i)}))}{\epsilon}\right)^2
\right\}
\end{equation}
It is worth noting that this representation of the likelihood is only
possible within the particle filter;
in other approaches, such as the Kalman filter,
the likelihood cannot be calculated using the distance as the estimate
is a distribution, and so instead a reverse non-deterministic transformation
is required, which introduces additional error and uncertainty into the model.

The posterior distribution is obtained by \emph{selection},
or resampling with replacement using likelihood weights
\begin{equation*}
W_k^{(i)} = \frac{p(\bY_k | \bX_k^{(i)}, \epsilon)}{
    \sum_{j=1}^N p(\bY_k | \bX_k^{(j)}, \epsilon)
} 
W_{k-1}^{(i)} 
\end{equation*}
However, to improve efficiency, the state $\tilde \bX_k$ is only resampled
when the effective sample size 
$N_{\text{eff}}$ is less than some threshold,
\begin{equation*}
N_{\text{eff}} = \frac{1}{\sum_{i=1}^N (W_k^{(i)})} < N_{\text{thres}}
\end{equation*}
When resampling is performed, $W_k^{(i)} := N^{-1}$ for all $i$.


\subsection{Network model}
\label{sec:kf}

The second part of this appraoch involves a network model of transit network travel times along links in the network.
Reliable ETAs will require a historical data component,
used as a prior in the absense of data as well as for
predicting future states, 
and a realtime update component where the travel times of vehicles
are used to update the current estimate of network state.

The model will be another recursive Bayesian model as used for the vehicle state,
as this provides a simple way to model realtime data.
Since travel times can safely be assumed to be unimodal,
we use an information filter (IF),
which is a transformation of the Kalman filter
using information instead of covariance,
and allows the simple combination of multiple observations,
for example when multiple buses traverse a road in the same update.
The prediction step will involve a transition function that incorporates historical data
and the update step will weight between observed and predicted travel times.

The network state $\boldsymbol\theta_c = \{\theta_c^\ell\}_{\ell = 1}^L$ is the travel time 
of transit vehicles along road segment $\ell$ at time $t_c$.
In this implementation, we are assuming independence between each segment
to provide a simple basis for the model; of course in reality this
is not true and future work will investigate ways of incorporating this.

Since the road state model is very simple, 
no transition matrix or measurement matrix is required,
and the model from (\ref{eq:rbe_model}) reduces to
\begin{equation}
\begin{split}
\hat \theta_c^\ell &= \theta_{c-1}^\ell + \Delta_c^\ell v_c^\ell \\
Z_c^\ell &= \theta_c^\ell + e_c^\ell
\end{split}
\end{equation}
where $\Delta_c = t_c - t_{c-1}$,
$v_c^\ell \sim \mathrm{N}(0, \nu^2)$ is the system noise,
and $e_c^\ell \sim \mathrm{N}(0, R_c^\ell)$ is the measurement error
as estimated from the vehicle model using particle uncertainty.

The state is estimated by its mean $\hat \theta_c^\ell = \mathrm{E}(\theta_c^\ell)$
and uncertainty $P_c^\ell = \mathrm{var}(\theta_c^\ell)$,
which are predicted from the previous state estimate using the prediction
equations
\begin{align*}
\label{eq:kf_transition}
\hat \theta^\ell_{c|c-1} &= \hat \theta^\ell_{c|c-1} \\
P^\ell_{c|c-1} &= P^\ell_{c-1|c-1} + \Delta_c^\ell \nu_c^\ell
\end{align*}

For the update step, however, we need to transform into an information
space parameterised by the information matrix $U^\ell_c$
and the information vector $u^\ell_c$,
\begin{equation}
\label{eq:information_transform}
U^\ell_{c|c-1} = \frac{1}{P_{c|c-1}}
\quad\text{and}\quad
\hat u^\ell_{c|c-1} = \frac{\hat \theta^\ell_{c|c-1}}{P^\ell_{c|c-1}}
\end{equation}
The measurement data obtained from the vehicle model are
the travel time of vehicle $m$ along segment $\ell$,
$\bar z_c^{m\ell}$, and the uncertainty $s^{m\ell}_c$.
These can be transformed to a measurement information covaraince matrix
and vector using the measurement matrix,
\begin{equation*}
B^{m\ell}_c = \frac{1}{(s^{m\ell}_c)^{2}}\quad\text{and}\quad
b^{m\ell}_c = \frac{\bar z^{m\ell}_c}{(s^{m\ell}_c)^2}
\end{equation*}
The information update is now the sum of the information for all vehicles
that traversed the segment since the last update, so
\begin{align*}
U^\ell_{c|c} &= U^\ell_{c|c-1} + \sum_{m=1}^M B^{m\ell}_{c} \\
\hat u^\ell_{c|c} &= \hat u^\ell_{c|c-1} + \sum_{m=1}^M b^{m\ell}_{c}
\end{align*}
which are back transformed to get the updated state parameters
using the inverse of (\ref{eq:information_transform})
\begin{equation*}
\hat \theta^\ell_{c|c} = \frac{\mathbf{\hat u}^\ell_{c|c}}{\mathbf{U}^\ell_{c|c}} 
\quad\text{and}\quad
P^\ell_{c|c} = \frac{1}{\mathbf{U}^\ell_{c|c}}.
\end{equation*}



